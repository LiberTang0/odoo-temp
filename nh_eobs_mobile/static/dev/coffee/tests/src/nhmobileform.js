// Generated by CoffeeScript 1.8.0
var NHMobileForm,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

NHMobileForm = (function(_super) {
  __extends(NHMobileForm, _super);

  function NHMobileForm() {
    this.display_partial_reasons = __bind(this.display_partial_reasons, this);
    this.submit = __bind(this.submit, this);
    this.trigger_actions = __bind(this.trigger_actions, this);
    this.validate = __bind(this.validate, this);
    var input, self, _fn, _i, _len, _ref, _ref1;
    this.form = (_ref = document.getElementsByTagName('form')) != null ? _ref[0] : void 0;
    this.form_timeout = 240 * 1000;
    self = this;
    NHMobileForm.__super__.constructor.call(this);
    _ref1 = this.form.elements;
    _fn = function() {
      switch (input.localName) {
        case 'input':
          switch (input.type) {
            case 'number':
              return input.addEventListener('change', self.validate);
            case 'submit':
              return input.addEventListener('click', self.submit);
          }
          break;
        case 'select':
          return input.addEventListener('change', self.trigger_actions);
      }
    };
    for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
      input = _ref1[_i];
      _fn();
    }
    document.addEventListener('form_timeout', function(event) {
      return console.log('oh noes the form timed out');
    });
    this.timeout_func = function() {
      var timeout;
      timeout = new CustomEvent('form_timeout', {
        'detail': 'form timed out'
      });
      return document.dispatchEvent(timeout);
    };
    window.form_timeout = setTimeout(window.timeout_func, this.form_timeout);
  }

  NHMobileForm.prototype.validate = function(event) {
    var container_el, criteria, error_el, input, max, min, other_input, value, _ref;
    event.preventDefault();
    clearTimeout(window.form_timeout);
    window.form_timeout = setTimeout(this.timeout_func, this.form_timeout);
    input = event.srcElement;
    container_el = input.parentNode.parentNode;
    error_el = container_el.getElementsByClassName('input-body')[0].getElementsByClassName('errors')[0];
    if (input.type === 'number') {
      value = parseFloat(input.value);
      min = parseFloat(input.min);
      max = parseFloat(input.max);
      container_el.classList.remove('error');
      input.classList.remove('error');
      error_el.innerHTML = '';
      if (input.step === '1' && value % 1 !== 0) {
        container_el.classList.add('error');
        input.classList.add('error');
        error_el.innerHTML = '<label for="' + input.name + '" class="error">Must be whole number</label>';
        return;
      }
      if (value < min) {
        container_el.classList.add('error');
        input.classList.add('error');
        error_el.innerHTML = '<label for="' + input.name + '" class="error">Input too low</label>';
        return;
      }
      if (value > max) {
        container_el.classList.add('error');
        input.classList.add('error');
        error_el.innerHTML = '<label for="' + input.name + '" class="error">Input too high</label>';
        return;
      }
      if (input.getAttribute('data-validation')) {
        criteria = eval(input.getAttribute('data-validation'))[0];
        other_input = (_ref = document.getElementById(criteria[1])) != null ? _ref.value : void 0;
        if (other_input && !eval(value + ' ' + criteria[0] + ' ' + other_input)) {
          container_el.classList.add('error');
          input.classList.add('error');
          error_el.innerHTML = '<label for="' + input.name + '" class="error">Input must be ' + criteria[0] + ' ' + criteria[1] + '</label>';
        }
      }
    } else {

    }
  };

  NHMobileForm.prototype.trigger_actions = function(event) {
    var actions, el, field, input, value, _i, _j, _len, _len1, _ref, _ref1, _ref2, _ref3, _results;
    event.preventDefault();
    clearTimeout(window.form_timeout);
    window.form_timeout = setTimeout(this.timeout_func, this.form_timeout);
    input = event.srcElement;
    value = input.value;
    if (input.getAttribute('data-onchange')) {
      actions = eval(input.getAttribute('data-onchange'))[0];
      _ref1 = (_ref = actions[value]) != null ? _ref['hide'] : void 0;
      for (_i = 0, _len = _ref1.length; _i < _len; _i++) {
        field = _ref1[_i];
        el = document.getElementById('parent_' + field);
        el.style.display = 'none';
      }
      _ref3 = (_ref2 = actions[value]) != null ? _ref2['show'] : void 0;
      _results = [];
      for (_j = 0, _len1 = _ref3.length; _j < _len1; _j++) {
        field = _ref3[_j];
        el = document.getElementById('parent_' + field);
        _results.push(el.style.display = 'block');
      }
      return _results;
    }
  };

  NHMobileForm.prototype.submit = function(event) {
    var element, form_elements, valid_form;
    event.preventDefault();
    clearTimeout(window.form_timeout);
    window.form_timeout = setTimeout(this.timeout_func, this.form_timeout);
    form_elements = (function() {
      var _i, _len, _ref, _results;
      _ref = this.form.elements;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        element = _ref[_i];
        if (!element.classList.contains('exclude')) {
          _results.push(element);
        }
      }
      return _results;
    }).call(this);
    valid_form = function() {
      var _i, _len;
      for (_i = 0, _len = form_elements.length; _i < _len; _i++) {
        element = form_elements[_i];
        if (element.classList.contains('error') || !element.value) {
          return false;
        }
      }
      return true;
    };
    if (valid_form()) {
      return console.log('submit');
    } else {
      return this.display_partial_reasons(this);
    }
  };

  NHMobileForm.prototype.display_partial_reasons = function(self) {
    return Promise.when(this.call_resource(this.urls.json_partial_reasons())).then(function(data) {
      var option, option_name, option_val, options, select, _i, _len, _ref;
      console.log(data);
      options = '';
      _ref = data[0];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        option = _ref[_i];
        option_val = option[0];
        option_name = option[1];
        options += '<option value="' + option_val + '">' + option_name + '</option>';
      }
      select = '<select name="partial_reason">' + options + '</select>';
      return new window.NH.NHModal('partial_reasons', 'Submit partial observation', '<p class="block">Please state reason for submitting partial observation</p>' + select, ['<a href="#" data-action="close" data-target="partial_reasons">Cancel</a>', '<a href="#" data-action="confirm">Confirm</a>'], 0, self.form);
    });
  };

  return NHMobileForm;

})(NHMobile);

if (!window.NH) {
  window.NH = {};
}

if (typeof window !== "undefined" && window !== null) {
  window.NH.NHMobileForm = NHMobileForm;
}
